/* fsusb2i   (c) 2015 trinity19683
  IT9175 USB interface, tuner, demod
  it9175_priv.h
  2015-12-31
*/
#pragma once

#define USB_TIMEOUT 400   //# USB ctrl timeout (msec)
#define EP_CTRLBULK  0x02   //# ctrl
#define EP_CTRLBULKRES  0x81   //# ctrl response
#define EP_TS1  0x84   //# TS data

#define MAX_XFER_SIZE 64   //# USB ctrl msg buffer size
#define REQ_HDR_LEN 4   //# send header size
#define ACK_HDR_LEN 3   //# response header size
#define CHECKSUM_LEN 2

#define I2C_ADDR_EEPROM  0xA0

#define EEPROM_BASE_IT9175  0x499C
#define EEPROM_IR_MODE      0x10
#define EEPROM_TS_MODE      0x29
#define EEPROM_1_TUNER_IF   0x2B
#define EEPROM_1_TUNER_ID   0x34

/* USB commands */
#define CMD_MEM_RD          0x00
#define CMD_MEM_WR          0x01
#define CMD_CFG_RD          0x04
#define CMD_CFG_WR          0x05
#define CMD_FW_DL           0x21
#define CMD_FW_QUERYINFO    0x22
#define CMD_FW_BOOT         0x23
#define CMD_FW_SCATTER_WR   0x29


struct state_st {
	HANDLE fd;    //# devfile descriptor
	uint8_t volatile  seq;    //# ctrl sequence number
	PMUTEX pmutex;    //# mutex for USB device (pthread_mutex_t)
	uint8_t buf[MAX_XFER_SIZE];    //# USB transfer buffer
	uint32_t chip_id;
	uint32_t fw_info;    //# firmware info (0=invalid)
	uint8_t tunerID;
	uint8_t clock_d;
	uint8_t fdiv;
	uint8_t bw_mode;
	uint16_t xtal;
	uint32_t freq_bd;
	//uint32_t clock_x;
	//uint32_t clock_a;
};

static const unsigned int clock_lut_dev[] = { /* kHz */
	12000, 20480, 36000, 30000, 26000,
	28000, 32000, 34000, 24000, 22000,
};

static const uint8_t inittab_1[] = {
 3, 0x29,0x00,0,0,0,
 2, 0x37,0x00,0x10,0x27,
 2, 0x3A,0x00,0x10,0x27,
 1, 0x4B,0x00,0x01,
 1, 0x4D,0x00,0x01,
 1, 0x51,0x00,0x01,
 2, 0x55,0x00,0x01,0x00,
 1, 0x65,0x00,0x50,
 1, 0x70,0x00,0x0A,
 1, 0x7E,0x00,0x04,
 1, 0x81,0x00,0x0A,
 9, 0x8A,0x00,0x01,0x07,0x07,0x06,0x01,0x20,0x2C,0x01,0x06,
 1, 0x99,0x00,0x01,
 2, 0x9F,0x00,0xE1,0xCF,
 1, 0xA3,0x00,0x01,
 2, 0xA5,0x00,0x01,0x01,
 2, 0xA9,0x00,0x00,0x01,
 1, 0xB0,0x00,0x01,
 1, 0xC2,0x00,0x05,
 1, 0xC6,0x00,0x19,
 4, 0xF8,0x00,0x10,0x27,0x10,0x27,
 4, 0x01,0x01,0x10,0x27,0x10,0x27,
 2, 0xB5,0x01,0x2B,0x0B,
 2, 0xC6,0x01,0x01,0x01,
 1, 0x00,0xF0,0x0F,
 1, 0x2B,0xF0,0x00,
 4, 0x64,0xF0,0x03,0xF9,0x03,0x01,
 2, 0x6F,0xF0,0xE0,0x03,
 2, 0x72,0xF0,0x0F,0x03,
 1, 0x78,0xF0,0x00,
 1, 0x87,0xF0,0x00,
 6, 0x9B,0xF0,0x3F,0x00,0x20,0x00,0x0C,0x00,
 1, 0x30,0xF1,0x04,
 1, 0x32,0xF1,0x04,
 1, 0x44,0xF1,0x1A,
 1, 0x46,0xF1,0x00,
 1, 0x4A,0xF1,0x01,
 2, 0x4C,0xF1,0x00,0x00,
 1, 0x4F,0xF1,0x04,
 1, 0x58,0xF1,0x7F,
 2, 0x5A,0xF1,0x00,0x08,
 3, 0x5D,0xF1,0x03,0x05,0x02,
 1, 0x63,0xF1,0x05,
 4, 0x66,0xF1,0x01,0x40,0x0F,0x08,
 2, 0x7A,0xF1,0x00,0x00,
 1, 0x83,0xF1,0x01,
 1, 0x85,0xF1,0x00,
 1, 0x93,0xF1,0x00,
 1, 0x9D,0xF1,0x40,
 2, 0xBC,0xF1,0x36,0x00,
 2, 0xCB,0xF1,0xA0,0x01,
 1, 0x04,0xF2,0x11,
 1, 0x14,0xF2,0x00,
 3, 0x0E,0xF4,0x0A,0x40,0x08,
 1, 0xC2,0xF4,0x00,
 1, 0x06,0xF5,0x04,
 1, 0x42,0xF5,0x02,
 1, 0x5F,0xF5,0x0A,
 2, 0x61,0xF5,0x15,0x20,
 2, 0xDF,0xF5,0xFB,0x00,
 3, 0xE3,0xF5,0x09,0x01,0x01,
 1, 0xF8,0xF5,0x01,
 1, 0xFD,0xF5,0x01,
 8, 0x00,0xF6,0x05,0x08,0x0B,0x0E,0x11,0x14,0x17,0x1F,
 4, 0x0E,0xF6,0x00,0x04,0x32,0x10,
 1, 0x2E,0xF6,0x64,
 4, 0x07,0xF7,0xFC,0x00,0x37,0x00,
 1, 0x98,0xF7,0x0D,
 3, 0x0F,0xF8,0x40,0x54,0x5A,
 1, 0x06,0xFB,0x03,
 1, 0x00,0xFD,0x01,
 1, 0x85,0xFD,0x00,
 1, 0x8A,0xFD,0x03,
 2, 0x9D,0xFD,0x00,0x05,
0 };

static const uint8_t inittab_2[] = {
 1, 0x43,0x00,0x00,
 1, 0x46,0x00,0x70,
 2, 0x5F,0x00,0x00,0x00,
 1, 0x68,0x00,0x0A,
 1, 0x6A,0x00,0x03,
 2, 0x71,0x00,0x05,0x02,
 5, 0x75,0x00,0x8C,0x8C,0x8C,0x8C,0x01,
 1, 0x82,0x00,0x13,
 6, 0x84,0x00,0x0A,0x33,0xBE,0x94,0xC6,0xA0,
 4, 0x93,0x00,0x00,0x00,0x00,0x00,
 2, 0x9B,0x00,0x3C,0x28,
 1, 0xA4,0x00,0x5A,
 2, 0xB3,0x00,0x02,0x6A,
 1, 0xB6,0x00,0x14,
 2, 0xC0,0x00,0x11,0x00,
 2, 0xC3,0x00,0x01,0x00,
 1, 0xC7,0x00,0x00,
 3, 0xCC,0x00,0x2C,0x4F,0x30,
 1, 0x38,0x01,0x01,
 3, 0x3B,0x01,0x05,0xA0,0x8C,
 3, 0x40,0x01,0x03,0x06,0x06,
10, 0x44,0x01,0x03,0x03,0x02,0x08,0x50,0x6E,0x8C,0x02,0xBE,0x00,
 1, 0x4F,0x01,0x00,
 2, 0x5B,0x01,0x0A,0x03,
 1, 0x61,0x01,0xA0,
 1, 0x64,0x01,0x00,
 4, 0x67,0x01,0x50,0x50,0x47,0x42,
 1, 0x77,0x01,0x03,
16, 0x7A,0x01,0x59,0x59,0xFA,0x5A,0x5A,0x8C,0x8C,0x8C,0x6E,0x8C,0x50,0x8C,0x8C,0xA0,0xC6,0x33,
 1, 0x8B,0x01,0x28,
 4, 0x8D,0x01,0xBC,0x00,0x01,0x00,
 1, 0x92,0x01,0x5E,
 1, 0x94,0x01,0x09,
12, 0x97,0x01,0x00,0x00,0x94,0x6E,0x02,0xEE,0x32,0x01,0x46,0x0E,0x05,0x06,
 2, 0xB3,0x01,0x02,0x00,
12, 0xB7,0x01,0x01,0x07,0x05,0x03,0x03,0x01,0x05,0x27,0x01,0x3F,0x02,0x1F,
 6, 0xD4,0x01,0x01,0x05,0x01,0x01,0x03,0x01,
 1, 0xDC,0x01,0x01,
 1, 0xE5,0x01,0x48,
 4, 0x1D,0xED,0x06,0x06,0x06,0x06,
 2, 0x1F,0xF0,0x8C,0x00,
 2, 0x29,0xF0,0x8C,0x00,
 1, 0x77,0xF0,0x01,
 3, 0x46,0xF2,0x01,0x03,0x01,
 5, 0x4C,0xF2,0x88,0x95,0x9A,0x90,0x09,
 5, 0x5A,0xF2,0x07,0xE8,0x03,0xB0,0x04,
 1, 0x69,0xF2,0x07,
 4, 0x70,0xF2,0x01,0x02,0x01,0x02,
0 };


/*EOF*/
